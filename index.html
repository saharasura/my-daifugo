<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¤§å¯Œè±ª</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Lucide-reactã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç°¡æ˜“çš„ã«å†ç¾ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .icon-placeholder { display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // Reactã®ãƒ•ãƒƒã‚¯ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰å–å¾—
        const { useState, useEffect, useCallback } = React;

        // ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç°¡æ˜“ç‰ˆï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã®ä»£ã‚ã‚Šï¼‰
        const Users = () => <span class="icon-placeholder">ğŸ‘¥</span>;
        const LogOut = () => <span class="icon-placeholder">ğŸšª</span>;
        const Copy = () => <span class="icon-placeholder">ğŸ“‹</span>;
        const Check = () => <span class="icon-placeholder">âœ…</span>;
        const Eye = () => <span class="icon-placeholder">ğŸ‘ï¸</span>;
        const EyeOff = () => <span class="icon-placeholder">ğŸ™ˆ</span>;
        const RotateCcw = () => <span class="icon-placeholder">ğŸ”„</span>;

        const OnlineDaifugoGame = () => {
            // Firebaseè¨­å®š
            const firebaseConfig = {
                apiKey: "AIzaSyAphoRCf5yD80micou5WBvH8Y7MtBTK-uI",
                authDomain: "my-daifugo-game.firebaseapp.com",
                databaseURL: "https://my-daifugo-game-default-rtdb.firebaseio.com",
                projectId: "my-daifugo-game",
                storageBucket: "my-daifugo-game.firebasestorage.app",
                messagingSenderId: "119119094779",
                appId: "1:119119094779:web:701573efd01b1116b2e15e"
            };

            const [firebase, setFirebase] = useState(null);
            const [database, setDatabase] = useState(null);
            const [gameState, setGameState] = useState('lobby'); 
            const [roomId, setRoomId] = useState('');
            const [inputRoomId, setInputRoomId] = useState('');
            const [playerId, setPlayerId] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [inputPlayerName, setInputPlayerName] = useState('');
            const [gameData, setGameData] = useState(null);
            const [myPlayerIndex, setMyPlayerIndex] = useState(-1);
            const [showHand, setShowHand] = useState(true);
            const [selectedCards, setSelectedCards] = useState([]);
            const [message, setMessage] = useState('');
            const [copied, setCopied] = useState(false);

            const SUITS = {
                hearts: { symbol: 'â™¥', color: 'text-red-500' },
                diamonds: { symbol: 'â™¦', color: 'text-red-500' },
                clubs: { symbol: 'â™£', color: 'text-gray-800' },
                spades: { symbol: 'â™ ', color: 'text-gray-800' }
            };
            const RANKS = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
            const getRankValue = (rank) => RANKS.indexOf(rank);

            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                    const { getDatabase, ref, onValue, set, push, update, remove, get, off } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
                    const app = initializeApp(firebaseConfig);
                    const db = getDatabase(app);
                    setFirebase({ ref, onValue, set, push, update, remove, get, off });
                    setDatabase(db);
                    setPlayerId('player_' + Math.random().toString(36).substr(2, 9));
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!firebase || !database || !roomId) return;
                const roomRef = firebase.ref(database, `rooms/${roomId}`);
                const unsubscribe = firebase.onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setGameData(data);
                        const index = data.players.findIndex(p => p.id === playerId);
                        setMyPlayerIndex(index);
                        if (data.winner) setGameState('gameover');
                        else if (data.gameStarted) setGameState('playing');
                        else setGameState('waiting');
                    }
                });
                return () => firebase.off(roomRef);
            }, [firebase, database, roomId, playerId]);

            const createAndShuffleDeck = () => {
                const deck = [];
                Object.keys(SUITS).forEach(suit => {
                    RANKS.forEach(rank => deck.push({ suit, rank, id: `${suit}-${rank}` }));
                });
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
                return deck;
            };

            const createRoom = async () => {
                if (!firebase || !database || !inputPlayerName.trim()) {
                    setMessage('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                const newRoomRef = firebase.push(firebase.ref(database, 'rooms'));
                const newRoomId = newRoomRef.key;
                const initialData = {
                    players: [{ id: playerId, name: inputPlayerName.trim(), hand: [], hasPassed: false }],
                    currentPlayerIndex: 0, fieldCards: [], lastPlayedBy: null, passCount: 0, gameStarted: false, winner: null, createdAt: Date.now()
                };
                await firebase.set(newRoomRef, initialData);
                setRoomId(newRoomId);
                setPlayerName(inputPlayerName.trim());
                setGameState('waiting');
            };

            const joinRoom = async () => {
                if (!firebase || !database || !inputRoomId.trim() || !inputPlayerName.trim()) {
                    setMessage('ãƒ«ãƒ¼ãƒ IDã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                const roomRef = firebase.ref(database, `rooms/${inputRoomId.trim()}`);
                const snapshot = await firebase.get(roomRef);
                if (!snapshot.exists()) { setMessage('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
                const roomData = snapshot.val();
                if (roomData.gameStarted) { setMessage('æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™'); return; }
                if (roomData.players.length >= 4) { setMessage('æº€å“¡ã§ã™'); return; }
                const newPlayer = { id: playerId, name: inputPlayerName.trim(), hand: [], hasPassed: false };
                await firebase.update(roomRef, { [`players/${roomData.players.length}`]: newPlayer });
                setRoomId(inputRoomId.trim());
                setPlayerName(inputPlayerName.trim());
                setGameState('waiting');
            };

            const startGame = async () => {
                if (!firebase || !database || !roomId || !gameData) return;
                const deck = createAndShuffleDeck();
                const playerCount = gameData.players.length;
                const playerHands = Array(playerCount).fill(null).map(() => []);
                deck.forEach((card, index) => playerHands[index % playerCount].push(card));
                playerHands.forEach(hand => hand.sort((a, b) => getRankValue(a.rank) - getRankValue(b.rank)));
                const updates = {};
                gameData.players.forEach((player, index) => {
                    updates[`players/${index}/hand`] = playerHands[index];
                    updates[`players/${index}/hasPassed`] = false;
                });
                updates['gameStarted'] = true;
                updates['currentPlayerIndex'] = 0;
                updates['fieldCards'] = [];
                updates['lastPlayedBy'] = null;
                updates['passCount'] = 0;
                updates['winner'] = null;
                await firebase.update(firebase.ref(database, `rooms/${roomId}`), updates);
            };

            const toggleCardSelection = (cardId) => {
                setSelectedCards(prev => prev.includes(cardId) ? prev.filter(id => id !== cardId) : [...prev, cardId]);
            };

            const canPlayCards = () => {
                if (!gameData || myPlayerIndex === -1 || selectedCards.length !== 1) return false;
                if (gameData.currentPlayerIndex !== myPlayerIndex) return false;
                const myHand = gameData.players[myPlayerIndex].hand;
                const selectedCard = myHand.find(c => c.id === selectedCards[0]);
                if (!selectedCard) return false;
                if (gameData.fieldCards.length === 0) return true;
                const lastCard = gameData.fieldCards[gameData.fieldCards.length - 1];
                return getRankValue(selectedCard.rank) > getRankValue(lastCard.rank);
            };

            const playCards = async () => {
                if (!canPlayCards()) { setMessage('âŒ å‡ºã›ã¾ã›ã‚“'); return; }
                const myHand = gameData.players[myPlayerIndex].hand;
                const playedCards = myHand.filter(c => selectedCards.includes(c.id));
                const newHand = myHand.filter(c => !selectedCards.includes(c.id));
                const updates = {};
                updates[`players/${myPlayerIndex}/hand`] = newHand;
                updates[`players/${myPlayerIndex}/hasPassed`] = false;
                updates['fieldCards'] = playedCards;
                updates['lastPlayedBy'] = myPlayerIndex;
                updates['passCount'] = 0;
                if (newHand.length === 0) updates['winner'] = gameData.players[myPlayerIndex].name;
                else updates['currentPlayerIndex'] = (myPlayerIndex + 1) % gameData.players.length;
                await firebase.update(firebase.ref(database, `rooms/${roomId}`), updates);
                setSelectedCards([]);
            };

            const pass = async () => {
                if (gameData.currentPlayerIndex !== myPlayerIndex) return;
                const newPassCount = gameData.passCount + 1;
                const updates = {};
                updates[`players/${myPlayerIndex}/hasPassed`] = true;
                updates['passCount'] = newPassCount;
                if (newPassCount === gameData.players.length - 1) {
                    updates['fieldCards'] = [];
                    updates['lastPlayedBy'] = null;
                    updates['passCount'] = 0;
                    gameData.players.forEach((_, i) => updates[`players/${i}/hasPassed`] = false);
                }
                updates['currentPlayerIndex'] = (myPlayerIndex + 1) % gameData.players.length;
                await firebase.update(firebase.ref(database, `rooms/${roomId}`), updates);
            };

            const leaveRoom = () => { window.location.reload(); };
            const copyRoomId = () => { navigator.clipboard.writeText(roomId); setCopied(true); setTimeout(() => setCopied(false), 2000); };

            const Card = ({ card, isSelected, onClick, size = 'normal' }) => {
                const suitInfo = SUITS[card.suit];
                return (
                    <div onClick={onClick} className={`${size === 'small' ? 'w-10 h-14 text-xs' : 'w-14 h-20 text-base'} bg-white rounded shadow flex flex-col items-center justify-center border-2 transition-all ${isSelected ? 'border-blue-500 -translate-y-2' : 'border-gray-300'} ${onClick ? 'cursor-pointer' : ''}`}>
                        <div className={`font-bold ${suitInfo.color}`}>{card.rank}</div>
                        <div className={`text-xl ${suitInfo.color}`}>{suitInfo.symbol}</div>
                    </div>
                );
            };

            const isMyTurn = gameData?.currentPlayerIndex === myPlayerIndex;

            return (
                <div className="min-h-screen bg-green-700 flex flex-col items-center justify-center p-4 text-gray-900">
                    {gameState === 'lobby' && (
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                            <h1 className="text-3xl font-bold mb-6 text-center text-green-800">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¤§å¯Œè±ª</h1>
                            <input type="text" value={inputPlayerName} onChange={(e) => setInputPlayerName(e.target.value)} placeholder="åå‰" className="w-full p-3 border rounded mb-4"/>
                            <button onClick={createRoom} className="w-full bg-green-600 text-white p-3 rounded font-bold mb-4">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
                            <input type="text" value={inputRoomId} onChange={(e) => setInputRoomId(e.target.value)} placeholder="ãƒ«ãƒ¼ãƒ ID" className="w-full p-3 border rounded mb-2"/>
                            <button onClick={joinRoom} className="w-full bg-blue-600 text-white p-3 rounded font-bold">å‚åŠ ã™ã‚‹</button>
                            {message && <p className="text-red-500 mt-4 text-center">{message}</p>}
                        </div>
                    )}

                    {gameState === 'waiting' && gameData && (
                        <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md text-center">
                            <h2 className="text-xl font-bold mb-4">å¾…æ©Ÿä¸­... ID: {roomId}</h2>
                            <button onClick={copyRoomId} className="bg-gray-200 px-4 py-2 rounded mb-4">{copied ? 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿' : 'IDã‚’ã‚³ãƒ”ãƒ¼'}</button>
                            <div className="text-left mb-6">
                                {gameData.players.map(p => <div key={p.id} className="p-2 border-b">{p.name} {p.id === playerId && '(ã‚ãªãŸ)'}</div>)}
                            </div>
                            {myPlayerIndex === 0 && <button onClick={startGame} className="w-full bg-green-600 text-white p-3 rounded font-bold">ã‚²ãƒ¼ãƒ é–‹å§‹</button>}
                        </div>
                    )}

                    {gameState === 'playing' && gameData && (
                        <div className="w-full max-w-md">
                            <div className="bg-white p-4 rounded-lg mb-4 flex justify-between">
                                <span>ã‚¿ãƒ¼ãƒ³: <b>{gameData.players[gameData.currentPlayerIndex].name}</b></span>
                                {isMyTurn && <span className="text-green-600 font-bold">ã‚ãªãŸã®ç•ªï¼</span>}
                            </div>
                            <div className="h-32 flex items-center justify-center bg-green-800/50 rounded-lg mb-4">
                                {gameData.fieldCards.length > 0 ? <Card card={gameData.fieldCards[0]} /> : <span className="text-white/50">å ´ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</span>}
                            </div>
                            <div className="bg-white p-4 rounded-lg mb-4">
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {gameData.players[myPlayerIndex].hand.map(c => <Card key={c.id} card={c} isSelected={selectedCards.includes(c.id)} onClick={() => toggleCardSelection(c.id)} />)}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={pass} disabled={!isMyTurn} className="flex-1 bg-gray-500 text-white p-4 rounded font-bold">ãƒ‘ã‚¹</button>
                                <button onClick={playCards} disabled={!canPlayCards()} className="flex-1 bg-blue-600 text-white p-4 rounded font-bold">å‡ºã™</button>
                            </div>
                        </div>
                    )}

                    {gameState === 'gameover' && (
                        <div className="bg-white p-8 rounded-2xl shadow-xl text-center">
                            <h2 className="text-2xl font-bold mb-4">å‹åˆ©è€…: {gameData.winner}ï¼</h2>
                            <button onClick={leaveRoom} className="bg-green-600 text-white p-3 rounded font-bold">æˆ»ã‚‹</button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OnlineDaifugoGame />);
    </script>
</body>
</html>
